---
typora-root-url: /Users/ness001/Library/Mobile Documents/com~apple~CloudDocs/plots
---

# 探索性数据分析

数据类型分为三种

- 面板型数据
- 时间序列数据
- 截面数据

我们的数据有多支股票在不同时间段的样本信息，是典型的面板数据。而面板数据不易于进行探索性数据分析，所以在这里我们选择一支个股的时间序列数据为例进行探索。经过随机抽取，我们抽到股票代码为002064.SZ的股票，接下来这一部分（探索性数据分析和简单模型解释）的所有数据分析细节都以这只股票作为例子。

## 个股简介

深股代码002064，名为华峰氨纶，属于制造业板块。浙江华峰氨纶股份有限公司成立于1999年12月,是华峰集团控股子公司,公司专业从事氨纶纤维的生产、销售和技术开发,生产规模居全球氨纶制造企业前列,是国家火炬计划重点高新技术企业、全国化纤行业竞争力十强企业、首批全国资源节约型和环境友好型试点企业、首届中国工业行业履行社会责任五星级企业。2006年,公司成功实现A股上市,成为温州首家国内上市民营企业和全国首家主营氨纶上市公司。经营范围 氨纶产品的加工制造、销售、技术开发(涉及许可证经营的凭许可证经营),以及代理氨纶相关设备及产品的进出口业务。

**氨纶**（英文：Spandex/Elastane），俗称**莱卡**（英语：Lycra），是一种[弹力](https://zh.wikipedia.org/wiki/%E5%BC%B9%E5%8A%9B)[纤维](https://zh.wikipedia.org/wiki/%E7%BA%A4%E7%BB%B4)，由[美国](https://zh.wikipedia.org/wiki/%E7%BE%8E%E5%9B%BD)[杜邦](https://zh.wikipedia.org/wiki/%E6%9D%9C%E9%82%A6)公司于1958年发明[[1\]](https://zh.wikipedia.org/wiki/%E6%B0%A8%E7%B6%B8#cite_note-1)[[2\]](https://zh.wikipedia.org/wiki/%E6%B0%A8%E7%B6%B8#cite_note-Flynn-2)[[3\]](https://zh.wikipedia.org/wiki/%E6%B0%A8%E7%B6%B8#cite_note-3)[[4\]](https://zh.wikipedia.org/wiki/%E6%B0%A8%E7%B6%B8#cite_note-4)[[5\]](https://zh.wikipedia.org/wiki/%E6%B0%A8%E7%B6%B8#cite_note-5)。其具有很强的弹性，伸展度可达600%，且能回复原样，比[橡胶](https://zh.wikipedia.org/wiki/%E6%A9%A1%E8%83%B6)的强度更大、更透气，也更耐磨[[2\]](https://zh.wikipedia.org/wiki/%E6%B0%A8%E7%B6%B8#cite_note-Flynn-2)。当它第一次面世的时候，彻底改变了服装行业的许多领域。

## 构造新特征

## 九个财务指标

润色报告的同学多多调查下(*^▽^*)

### roe指标

roe简介。我们使用如下公式构造roe指标。

```python
df['roe']=df['净利润 (元，下同)']/df['股东权益合计(含少数股东权益)']
```

### 时间特征

以报告期作为时间基底，我们从中提取出季度和年份。

## 图表分析

#### 箱线图

对该支股票每个季度的营业收入做箱线图，观察是否有异常值，以及每个季度的数据分布情况。

[图片]

我们可以看到该个股在10年范围内第一第二季度各有一个异常值，我们对这两个异常值做删除处理。此外，通过观察季度趋势，可以明显地看出来，对于氨纶制造业来说第四季度是旺季，第一季度是淡季，这样一个上升的趋势也非常符合直觉。因为氨纶是服装业的重要原料，而服装产业往往是随着季节变化而需求陡增，所以每一季度比上一季度营业收入提高。(此处可以用服装产业淡旺季文献作为支撑)。https://m.sohu.com/n/382619642/

#### 核密度估计图

除了从季度的角度看公司营业收入，我们也应该从整体的角度观察目标变量。我们对整个时间跨度内的营业收入数据做一张核密度估计图，可以看到营业收入大部分集中在0-2000单位以内。

图片[]

黑色线代表正态分布曲线，显然我们的数据不是正态分布。在做D’Agostino and Pearson’s正态性检验后，我们得到的p值很小，拒绝数据来自正态分布的原假设。

```
NormaltestResult(statistic=14.002069447051158, pvalue=0.0009109389078183592)
```

### 折线图

营业收入在年度的变化趋势可以由以下折线图给出。在2017年时点处营业收入陡升，随后又回归原来的水平。经过调查，2017年氨纶产业经历了一波原材料价格大幅上涨的时期，氨纶制造公司为了缓解经营压力而提高了产品价格，故而营业收入有一个陡升的现象。

[]

公司的月度变化趋势可以由以下折线图给出。

[]

可以发现从月度角度来看，营业收入既有趋势性又有异方差性，如果我们要进行时间序列建模，那么必须对这两者进行处理。在对数差分操作以后，我们的数据变得平稳，说明这是一个有效的手段。

### 处理大量变量

我们数据呈现一个观测数目少而特征多的情况，这就使得一些建模手段会因为逆矩阵不存在而无法建立模型。所以对大量变量进行处理是我们必须要做的。

#### 热力图

通过相关矩阵检查变量之间信息是否重复。

[]

我们把相关矩阵映射到热力图上发现，图片的左上角颜色较浅，即各个变量之间相关程度较高，信息重复较多。

再看响应变量和各个变量之间的相关性。

[]

我们可以发现营业收入主要与财务数据相关性较高。

然而在统计中相关系数刻画的是线性相关性，所以这个相关系数热力图只是为了展示所用给出参考而已。

### 处理方法

对于变量的处理，初步考虑三种方法：第一种对变量进行聚类分析，然后再与相应变量之间做一个相关性分析，缺点在于需要自己判断哪些变量是需要纳入模型中的；第二种PCA主成分分析，选取方差较大的前几个，缺点在于得到的主成分含义没有直观上那么清楚；第三种是直接使用基于模型内部的变量选择工具，比如时间序列模型中使用bic准则进行变量选择，机器学习模型中的xgbosst的model selection。

为了让变量选择的过程更有可解释性，我们选择使用前两种方法进行特征选择。

#### 变量聚类

首先我们剔除目标变量和名义变量，使用jmp软件做了一个聚类分析，得到的结果如下所示。

[]

最终聚为21类，21个指标可以解释70%的其他变量的变化。按照解释变异的比例排序我们发现与常识相反的是流动比率速动比率没有想象的那么重要。

#### PCA降维

pca介绍。

在聚类分析中我们已经得到了21个类，我们把0.2的变异比例作为threshold，可以得到13个类，其实这13个聚类成分也可以通过jmp软件作为某种意义上的主成分导出，但是不如主成分降维那样有解释性，所以我们还是选择最传统的主成分分析方法。我们将一百多个变量降为13个主成分。

[] 数据的图片

做一个热力图，我们发现主成分之间没有任何相关性，说明信息已经不重复了，接下来我们来到建模部分。

## 建模

因为数据不来自于正态分布，所以我们在之后的建模中将不适用传统的时间序列建模方法，而是使用机器学习中的随机森林算法和xgboost算法进行分析。因为这只是探索性建模，所以我们在这里构造一个分类问题，而在之后的nn模型中再进行真正的预测建模。我们构造了一个新指标"运营状况"作为分类问题的目标变量，它有三个水平，差，一般和好。又因为个股时间序列数据数据量较少，我们在这里不做训练集验证集的划分。

#### 随机森林

#### [][]

模型介绍

(写一下。。)

[]

模型如下

[]

我们将其中一个弱分类器展示出来。

[]

#### 分类器评估

[]

通过这个混淆矩阵可以看出，我们的分类器效果较好，误判的两个样本是把经营状况为一般判断为经营状况较差了。在股市中这样的误判是无伤大雅的，而如果它将较差的经营状况误判为好，那么投资者才会损失。当然分类器真正的好坏还要通过验证集和实际情况进行评估。

#### 主成分的重要程度

我们好奇的是哪些主成分是最重要的呢？我们通过eli5和shap的特征重要性数据分别输出两张特征重要性的表来交叉验证各个主成分的重要程度。(他们的计算方法还要搜索一下。)

eli5

[]

前五个变量是，p2 p9 p7 p6 p8

shap特征重要程度

[]

[]

前五个变量是，p2 p7 p13 p4 p5

共同入选的变量是p2和p7，这两个我们可以重点输出观察一下。



(输出的内容)

#### xgboost建模

随机森林是集成方法中的bagging方法，它的弱分类器之间是没有关系的而boosting方法则是在残差项上进行拟合来获得最优的分类器。我们选择boosting方法中的xgboost算法进行探索分析。在这里我们的目的不是为了预测，而是观察单个样本上，各个主成分对预测结果的贡献率。我们在建模后借助shap输出第一个样本的预测情况。

[]

[]

从上图可以看出，首先对于第一个样本的预测是准确的，该年该月经营状况一般。其次对于第一个样本来说，p2p9p11p13对预测结果影响较大，而我们看主成分的数值的大小，发现贡献情况与数值绝对值大小没有太大关系。



